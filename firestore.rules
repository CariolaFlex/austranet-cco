rules_version = '2';

// ============================================================
// Austranet CCO — Reglas de Seguridad Firestore
// Versión: 2.0 (Sprint Capa Transversal — T-01 a T-06)
// Última actualización: 2026-02-27
//
// POLÍTICA: Solo usuarios autenticados del sistema CCO
//           pueden leer y escribir en la base de datos.
//           Reglas granulares por colección.
//
// COLECCIONES:
//   M1: usuarios, entidades, glosario, historial
//   M2: proyectos, repositorios_configuracion
//   M3: srs, requerimientos, sesiones_entrevista, escenarios,
//       casos_prueba, terminos_dominio_srs
//   T:  notificaciones, auditoria, configuracion, configuracion_dashboard
// ============================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------
    // Funciones auxiliares
    // --------------------------------------------------------
    function isAuthenticated() {
      return request.auth != null;
    }

    // --------------------------------------------------------
    // MÓDULO 0 — Usuarios
    // --------------------------------------------------------
    match /usuarios/{userId} {
      // Usuarios autenticados pueden leer y escribir su propio documento.
      // Admin/superadmin pueden leer todos (necesario para panel de usuarios).
      allow read: if isAuthenticated() && (
        request.auth.uid == userId
      );
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // --------------------------------------------------------
    // MÓDULO 1 — Entidades (con subcolecciones)
    // --------------------------------------------------------
    match /entidades/{entidadId} {
      allow read, write: if isAuthenticated();

      match /glosario/{terminoId} {
        allow read, write: if isAuthenticated();
      }

      match /historial/{entradaId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false; // Inmutable (M1-06)
      }
    }

    // --------------------------------------------------------
    // MÓDULO 2 — Proyectos (con subcolecciones)
    // --------------------------------------------------------
    match /proyectos/{proyectoId} {
      allow read, write: if isAuthenticated();

      match /historial/{entradaId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update, delete: if false; // Inmutable (M2-04)
      }
    }

    match /repositorios_configuracion/{configId} {
      allow read, write: if isAuthenticated();
    }

    // --------------------------------------------------------
    // MÓDULO 3 — Alcance / SRS
    // --------------------------------------------------------
    match /srs/{srsId} {
      allow read, write: if isAuthenticated();
    }

    match /requerimientos/{reqId} {
      allow read, write: if isAuthenticated();
      allow delete: if false; // Soft-delete (M3-09)
    }

    match /sesiones_entrevista/{sesionId} {
      allow read, write: if isAuthenticated();
    }

    match /escenarios/{escenarioId} {
      allow read, write: if isAuthenticated();
    }

    match /casos_prueba/{casoId} {
      allow read, write: if isAuthenticated();
    }

    match /terminos_dominio_srs/{terminoId} {
      allow read, write: if isAuthenticated();
    }

    // --------------------------------------------------------
    // T-02 — Notificaciones
    // --------------------------------------------------------
    match /notificaciones/{docId} {
      // Solo el destinatario puede leer su notificación
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.destinatarios;
      // Cualquier usuario autenticado puede crear notificaciones (servicios internos)
      allow create: if isAuthenticated();
      // Solo el destinatario puede actualizar (marcar leída, archivar)
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.destinatarios;
      // Nunca eliminar notificaciones
      allow delete: if false;
    }

    // --------------------------------------------------------
    // T-03 — Auditoría (write-only absoluto)
    // --------------------------------------------------------
    match /auditoria/{docId} {
      // Solo admin/superadmin pueden leer (en fase beta, todos autenticados)
      allow read: if isAuthenticated();
      // Cualquier usuario autenticado puede crear entradas de auditoría
      allow create: if isAuthenticated();
      // NUNCA modificar ni eliminar (inmutable por diseño)
      allow update, delete: if false;
    }

    // --------------------------------------------------------
    // T-06 — Configuración del sistema
    // --------------------------------------------------------
    match /configuracion/{docId} {
      // Todos los usuarios autenticados pueden leer (para modo mantenimiento, etc.)
      allow read: if isAuthenticated();
      // Solo admin/superadmin pueden escribir (regla en código, no en claim)
      allow write: if isAuthenticated();
    }

    // --------------------------------------------------------
    // T-05 — Configuración del dashboard (personal por usuario)
    // --------------------------------------------------------
    match /configuracion_dashboard/{uid} {
      allow read, write: if isAuthenticated() && request.auth.uid == uid;
    }

    // --------------------------------------------------------
    // BLOQUEO TOTAL para cualquier otra colección no listada
    // --------------------------------------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
